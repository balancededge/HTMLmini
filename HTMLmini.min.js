function HTMLmini(){HTMLmini.html=HTMLmini.Compiler.html,HTMLmini.stringify=HTMLmini.Compiler.stringify,HTMLmini.compile=HTMLmini.Compiler.compile}HTMLmini.Compiler=new function(){this.html=function(a,b,c){return HTMLmini.Generator.html(this.compile(a,b),c)},this.stringify=function(a,b,c){return HTMLmini.Generator.stringify(this.compile(a,b),c)},this.compile=function(a,b){return HTMLmini.Parser.parse(HTMLmini.Lexer.lex(a,b))}},HTMLmini.mode="strict",HTMLmini.tabSize=4,HTMLmini.preserveComments=!1,HTMLmini.emptyElements={area:"",base:"href",br:"",col:"",colgroup:"",command:"",embed:"src",hr:"hr",img:"src",input:"value",keygen:"",link:"href",meta:"content",param:"value",source:"src",track:"src",wbr:""},HTMLmini.aliases={css:{tag:"link",attr:{rel:"stylesheet",type:"text/css"}}},HTMLmini.modes={strict:[],relaxed:["ParserException"],silent:[]},HTMLmini.Generator=new function(){this.html=function(a,b){b=b||!1;var c=[];for(var d in a){var e=a[d],f=this.html(e.child,!0);if("undefined"!=typeof e.tag){var g=document.createElement(e.tag);"undefined"!=typeof e.id&&g.setAttribute("id",e.id);for(attr in e.attr)g.setAttribute(attr,e.attr[attr]);e.class.length>0&&g.setAttribute("class",e.class.join(" ")),void 0!=e.text&&g.appendChild(document.createTextNode(e.text));for(var h in f)g.appendChild(f[h]);c.push(g)}else c.push(document.createTextNode(e.text))}return b?c:c.shift()},this.stringify=function(a,b,c){b=b||0,c=c||0;var d=HTMLmini.pad(b*c),e=b>0?"\n":"",f="";for(var g in a){var h=a[g];if("undefined"!=typeof h.tag){f+=d+"<"+h.tag,"undefined"!=typeof h.id&&(f+=' id="'+h.id+'"');for(attr in h.attr)f+=" "+attr+(""!=h.attr[attr]?'="'+h.attr[attr]+'"':"");h.class.length>0&&(f+=' class="'+h.class.join(" ")+'"'),h.tag in HTMLmini.emptyElements?f+=">"+e:(f+=">","undefined"!=typeof h.text&&(f+=HTMLmini.escapeHTML(h.text)),h.child.length>0?f+=e+this.stringify(h.child,b,c+1)+d:"undefined"!=typeof h.text&&h.text.indexOf("\n")>-1&&(f+=e+d),f+="</"+h.tag+">"+e)}else f+=d+HTMLmini.escapeHTML(h.text)+e}return f.replace(/<!-->/g,"<!-- ").replace(/<\/!-->/g," -->")}},HTMLmini.Lexer=new function(){this.tokens={comment:/(\n *#.*)|(# .*)/,newline:/\n/,newinline:/>/,whitespace:/\s/,attrl:/\[ */,attrr:/\] */,text:/\| */,tag:/\w(\w|-)* */,id:/#\w(\w|-)* */,class:/\.\w(\w|-)* */,string:/("([^"\\]|\\.)*")|('([^'\\]|\\.)*') */},this.Token=function(a,b,c){"undefined"!=typeof c&&(this.name=c,this.source=HTMLmini.Lexer.tokens[c].exec(b)[0].trim()),this.line=a.split("\n").length-b.split("\n").length,this.char=a.length-b.length},this.lex=function(a,b){return this.tokenize(this.preprocess(a,b))},this.preprocess=function(a,b){for(var c in b)a=HTMLmini.replaceKey(a,c,b[c]);return HTMLmini.expandTabs(("\n"+a+"\n").replace(/\r\n|\r|\n/g,"\n"))},this.tokenize=function(a){var b=a,c=[];a:for(;b.length>0;){for(var d in this.tokens)if(HTMLmini.matchStart(this.tokens[d],b)){c.push(new this.Token(a,b,d)),b=b.replace(this.tokens[d],"");continue a}var e=new this.Token(a,b);HTMLmini.throw("Lexer","unknown character sequence: "+HTMLmini.hint(a),e.line,e.char)}return c}},HTMLmini.Parser=new function(){this.Element=function(a,b){this.indent=0,this.attr={},this.class=[],this.child=[],this.line=a,this.char=b},this.parse=function(a){return this.walk(this.processEmptyElements(this.elementalize(a)))},this.elementalize=function(a){this.elements=[],this.element=new this.Element,this.inattr=!1,this.intext=!1;for(var b in a){var c=a[b];c.name in this||HTMLmini.throw("Parser","malformed token "+c.name,c.line,c.char),this[c.name](c)}return this.elements},this.newline=function(a){"undefined"==typeof this.element.tag&&(Object.keys(this.element.attr).length>0||this.element.class.length>0)&&(this.element.tag="div"),"undefined"==typeof this.element.tag&&"undefined"==typeof this.element.text||this.elements.push(this.element),this.element=new this.Element(a.line+1,a.char),this.inattr=!1,this.intext=!1,delete this.attr},this.newinline=function(a){this.newline(a),this.elements.length>0&&(this.element.indent=this.elements[this.elements.length-1].indent)},this.whitespace=function(a){this.element.indent++},this.attrl=function(a){this.intext&&HTMLmini.throw("Parser","cannot open an attribute region in a text region",a.line,a.char),this.inattr=!0},this.attrr=function(a){this.intext?HTMLmini.throw("Parser","cannot close an attribute region in a text region",a.line,a.char):"undefined"!=typeof this.attr&&(this.element.attr[this.attr]="",delete this.attr),this.inattr=!1},this.text=function(a){this.inattr&&HTMLmini.throw("Parser","cannot define text in attributes",a.line,a.char),this.intext=!0},this.tag=function(a){if(this.inattr&&"undefined"==typeof this.attr)this.attr=a.source;else if(this.inattr)this.element.attr[this.attr]="",this.attr=a.source;else if(this.intext&&"undefined"!=typeof this.element.text)this.element.text+=" "+a.source;else if(this.intext)this.element.text=a.source;else if("undefined"==typeof this.element.tag){if(this.element.tag=a.source,a.source in HTMLmini.aliases){var b=HTMLmini.aliases[a.source];this.element.tag=b.tag||a.source,this.element.attr=b.attr||{},this.element.class=b.class||[],this.element.id=b.id,this.element.text=b.text}}else HTMLmini.throw("Parser","cannot redefine tag: "+this.element.tag,a.line,a.char)},this.id=function(a){"undefined"!=typeof this.element.id?HTMLmini.throw("Parser","cannot redefine id: "+this.element.id,a.line,a.char):this.inattr?HTMLmini.throw("Parser","cannot define id in attribute region: "+a.source,a.line,a.char):this.intext?this.comment(a):this.element.id=a.source.substring(1)},this.class=function(a){this.inattr?HTMLmini.throw("Parser","cannot define class in attributes: "+source,a.line,a.char):this.intext&&"undefined"==typeof this.element.text?this.element.text=a.source:this.intext?this.element.text+=a.source:this.element.class.push(a.source.substring(1))},this.string=function(a){this.inattr&&"undefined"!=typeof this.attr?(this.element.attr[this.attr]=HTMLmini.escapeString(a.source),delete this.attr):this.intext?this.element.text=HTMLmini.escapeString(a.source):"undefined"!=typeof this.element.tag||this.inattr?HTMLmini.throw("Parser","unexpected string "+a.source,a.line,a.char):(this.element.text=HTMLmini.escapeString(a.source),this.intext=!0)},this.comment=function(a){if(HTMLmini.preserveComments){var b=new this.Element(a.line+1,a.char);b.tag="!--",b.text=a.source.substring(1),this.inttext?b.indent=this.element.indent:this.element.length>0?b.indent=this.elements[this.elements.length-1].indent:b.indent=0,this.elements.push(b)}},this.processEmptyElements=function(a){for(var b in a){var c=a[b];c.tag in HTMLmini.emptyElements&&(""==HTMLmini.emptyElements[c.tag]&&"undefined"!=typeof c.text?HTMLmini.throw("Parser","cannot add text to empty element",c.line,c.char):"undefined"!=typeof c.text&&(c.attr[HTMLmini.emptyElements[c.tag]]=c.text))}return a},this.walk=function(a){var b=a.shift();if("undefined"==typeof b)return[];for(var c=[b],d=c,e=[],f=b.indent;a.length>0;)if(b=a.shift(),b.indent==f)d.push(b);else if(b.indent>f)b.tag in HTMLmini.emptyElements&&HTMLmini.throw("Parser","cannot add children to an empty element",b.line,b.char),e.push({current:d,indent:f}),d=d[d.length-1].child,f=b.indent,d.push(b);else if(b.indent<f){0==e.length&&HTMLmini.throw("Parser","invalid tree structure",b.line,b.char);var g=e.pop();d=g.current,f=g.indent,a.unshift(b)}return c}},HTMLmini.print=function(a){"object"==typeof a?console.log(JSON.stringify(a,null,4)):console.log(a)},HTMLmini.Exception=function(a,b,c,d,e){"undefined"!=typeof c&&"undefined "!=typeof d?this.message=a+"Exception: "+b+"    "+c+":"+d:this.message=a+"Exception: "+b,this.stack=e||(new Error).stack,this.name=a||"",this.name+="Exception"},HTMLmini.throw=function(a,b,c,d){if(!(a in HTMLmini.modes[HTMLmini.mode])&&"silent"!=HTMLmini.mode)throw new HTMLmini.Exception(a,b,c,d)},HTMLmini.assert=function(a,b){arguments.length<2&&(b=b||!0);var c={};if(!HTMLmini.equal(a,b,c))throw new HTMLmini.Exception("Assert",c.a+" "+c.err+" "+c.b)},HTMLmini.assertException=function(a,b){try{b()}catch(b){return void HTMLmini.assert(a,b.name)}throw new HTMLmini.Exception("Assert","No exception thrown")},HTMLmini.equal=function(a,b,c){if(deails=c||{},"object"!=typeof a&&"object"!=typeof b&&a!=b)return c.a=a,c.b=b,c.err="does not equal",!1;if("object"==typeof a&&"object"!=typeof b)return c.a="Object {}",c.b=b,c.err="cannot be compared to",!1;if("object"!=typeof a&&"object"==typeof b)return c.a=a,c.b="Object {}",c.err="cannot be compared to",!1;if("object"==typeof a&&"object"==typeof b){var d={};for(var e in a)if(!HTMLmini.equal(a[e],b[e],d))return c.a="Object {}["+e+"] : "+d.a,c.b="Object {}["+e+"] : "+d.b,c.err="does not equal",!1;for(var e in b)if(!HTMLmini.equal(a[e],b[e],d))return c.a="Object {}["+e+"] : "+d.a,c.b="Object {}["+e+"] : "+d.b,c.err="does not equal",!1}return!0},HTMLmini.pad=function(a){return a=a||0,Array(a+1).join(" ")},HTMLmini.escapeHTML=function(a){return a.replace(/[^0-9A-Za-z ]/g,function(a){return"&#"+a.charCodeAt(0)+";"})},HTMLmini.escapeString=function(a){return a=a.replace(/"\n/g,'"').replace(/'\n/g,"'").replace(/\n"/g,'"').replace(/\n'/g,"'"),a.startsWith('"')?(a=a.replace(/\\"/g,'"').replace(/\\\\/g,"\\"),a.endsWith('"')?a.substring(1,a.length-1):a.substring(1)):(a=a.replace(/\\\'/g,"'").replace(/\\\\/g,"\\"),a.endsWith("'")?a.substring(1,a.length-1):a.substring(1))},HTMLmini.expandTabs=function(a,b){return b=b||HTMLmini.tabSize,a=a.replace(/.*/g,function(a){for(var c=a.startsWith("\n")?1:0,d=0;d<a.length;d++)if("\t"==a[d]){var e=HTMLmini.pad(b-(d-c)%b);a=a.replace("\t",e)}return a})},HTMLmini.replaceKey=function(a,b,c){return c=c||"",a=a.replace(new RegExp(/ *?([^\\]|^)(\\\\)*:/.source+b,"g"),function(a){var d=HTMLmini.pad(a.search(/\S/));return a.replace(":"+b,c.replace(/\n/g,"\n"+d))})},HTMLmini.matchStart=function(a,b){return a=a.source||a,new RegExp("^"+a+"(.|s)*").test(b)},HTMLmini.hint=function(a,b){return b=b||10,a.substring(0,b).trim()+(a.length>=b?"...":"")};HTMLmini();